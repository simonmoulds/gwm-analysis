#!/usr/bin/env python3

import os
import subprocess

from grass_session import Session
from grass.script import core as gcore
import grass.script as gscript
import grass.script.setup as gsetup

# Import grass python libraries
from grass.pygrass.modules.shortcuts import general as g
from grass.pygrass.modules.shortcuts import raster as r
from grass.pygrass.modules.shortcuts import vector as v
from grass.pygrass.modules.shortcuts import temporal as t

from utils import write_reclass_rules

# Write the reclass rules that we need
write_reclass_rules()

# Directory where ESA CCI LC data is stored
esacci_datadir = snakemake.config['esacci_datadir']

# Now we can create a grass session instance
my_gisdb = os.path.join(os.getenv('HOME'), 'grassdata')
my_location = 'latlong'
my_mapset = 'gwm'

user = Session()
user.open(gisdb=my_gisdb, location=my_location, mapset=my_mapset)

try:
    r.mask(flags="r")
except:
    pass

# Import tropical forest area and infill
input_map = 'resources/wwf_terr_ecos.shp'
output_map = 'results/intermediate/wwf_terr_ecos_globe_0.008333Deg.tif'
gdal_rasterize_command = (
    'gdal_rasterize -at -te -180 -90 180 90 -ts 43200 21600 -a BIOME '
    f'{input_map} {output_map}'
)
os.system(gdal_rasterize_command)

grass_input_map = 'wwf_terr_ecos_globe_0.008333Deg'
r.in_gdal(flags="a", input=output_map, output=grass_input_map, overwrite=True)
r.null(map=grass_input_map, setnull=0)
r.grow_distance(
    input=grass_input_map,
    value=grass_input_map + '_interp',
    overwrite=True
)
r.mapcalc(
    f'tropical_broadleaf_forest_globe_0.008333Deg = if(({grass_input_map}_interp == 1) | ({grass_input_map}_interp == 2), 1, 0)'
)

# Read C4 fraction data
r.in_gdal(
    flags='a',
    input='results/intermediate/c4_nat_veg_frac_globe_0.008333Deg.tif',
    output='c4_nat_veg_frac_globe_0.008333Deg',
    overwrite=True
)
r.in_gdal(
    flags='a',
    input='results/intermediate/c4_crop_frac_globe_0.008333Deg.tif',
    output='c4_crop_frac_globe_0.008333Deg',
    overwrite=True
)

# Make JULES land cover fraction maps
lc_years = [2015]
g.region(region='igp_0.002778Deg')
r.mask(raster='esacci_land_frac_globe_0.002778Deg')

# Land sea mask @ 0.002778Deg
r.mapcalc('land_sea_mask = esacci_land_frac_globe_0.002778Deg', overwrite=True)
r.mask(flags='r')

for (year in lc_years):
    g.region(region='igp_0.002778Deg')
    input_map = os.path.join(
        esacci_datadir,
        f'ESACCI-LC-L4-LCCS-Map-300m-P1Y-{year}-v2.0.7.tif'
    )
    esa_lc_w_sea = f'esacci_lc_{year}_w_sea'
    r.in_gdal(flags='a', input=input_map, output=esa_lc_w_sea, overwrite=True)

    # Mask sea values in esacci_lc_${YEAR}_w_sea by multiplying by
    # land_sea_mask, in which non-land cells are null.
    esa_lc = f'esacci_lc_{year}'
    r.mapcalc(f'{esa_lc} = {esa_lc_w_sea} * land_sea_mask', overwrite=True)

    pfts = [
        'tree_broadleaf_evergreen', 'tree_broadleaf_deciduous',
        'tree_needleleaf_evergreen', 'tree_needleleaf_deciduous',
        'shrub_broadleaf_evergreen', 'shrub_broadleaf_deciduous',
        'shrub_needleleaf_evergreen', 'shrub_neefleleaf_deciduous',
        'natural_grass', 'managed_grass', 'urban', 'bare_soil',
        'water', 'snow_ice', 'no_data'
    ]
    for pft in pfts:
        # Recode at native resolution
        g.region(region='igp_0.002778Deg')
        r.reclass(
            input=esa_lc,
            output=f'esacci_lc_{year}_{pft}_x1000',
            rules=os.path.join('results/intermediate', f'{pft}_reclass.txt'),
            overwrite=True
        )
        # Resample at target resolution
        g.region(region='igp_0.008333Deg')
        r.resamp_stats(
            input=f'esacci_lc_{year}_{pft}_x1000',
            output=f'esacci_lc_{year}_{pft}_igp_0.008333Deg_x1000',
            method='average',
            overwrite=True
        )
        r.mapcalc(
            f'esacci_lc_{year}_{pft}_igp_0.008333Deg = esacci_lc_{year}_{pft}_igp_0.008333Deg_x1000 / 1000',
            overwrite=True
        )

    # Set up external output
    r.external_out(
        directory='results/intermediate/frac',
	    format='GTiff', options='COMPRESS=DEFLATE'
    )

    # Additional land cover classes we use to compute agricultural land

    # Rainfed cropland (classes 10, 11)
    g.region(region='igp_0.0027778Deg')
    r.mapcalc(
        f'esacci_lc_{year}_rainfed_cropland.tif = if(({esa_lc} == 10) || ({esa_lc} == 11), 1, 0)',
        overwrite=True
    )
    g.region(region='igp_0.008333Deg')
    r.resamp_stats(
        input=f'esacci_lc_{year}_rainfed_cropland.tif',
        output=f'esacci_lc_{year}_rainfed_cropland_igp_0.008333Deg.tif',
        method='average',
        overwrite=True
    )

    # Irrigated cropland (class 20)
    g.region(region='igp_0.0027778Deg')
    r.mapcalc(
        f'esacci_lc_{year}_irrigated_cropland.tif = if(({esa_lc} == 20), 1, 0)',
        overwrite=True
    )
    g.region(region='igp_0.008333Deg')
    r.resamp_stats(
        input=f'esacci_lc_{year}_irrigated_cropland.tif',
        output=f'esacci_lc_{year}_irrigated_cropland_igp_0.008333Deg.tif',
        method='average',
        overwrite=True
    )

    # Combined
    r.mapcalc(
        f'esacci_lc_{year}_cropland_igp_0.008333Deg.tif = esacci_lc_{year}_rainfed_cropland_igp_0.008333Deg.tif + esacci_lc_{year}_irrigated_cropland_igp_0.008333Deg.tif',
        overwrite=True
    )

    # 5 PFT
    # tree broadleaf
    r.mapcalc(
        'lc_tree_broadleaf_combined_{year}_igp_0.008333Deg.tif = esacci_lc_{year}_tree_broadleaf_evergreen_igp_0.008333Deg + esacci_lc_{year}_tree_broadleaf_deciduous_igp_0.008333Deg',
        overwrite=True
    )

    # TODO and so on
    # # ===================================================== #
    # # Convert to JULES land cover types
    # # ===================================================== #
    # g.region region=igp_0.008333Deg

    # # ###########
    # # (i) 5 PFT
    # # ###########

    # # tree broadleaf
    # r.mapcalc \
	# "lc_tree_broadleaf_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_tree_broadleaf_deciduous_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_broadleaf_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # tree needleleaf
    # r.mapcalc \
	# "lc_tree_needleleaf_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_needleleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_tree_needleleaf_deciduous_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_needleleaf_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # shrub
    # r.mapcalc \
	# "lc_shrub_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_shrub_broadleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_broadleaf_deciduous_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_needleleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_needleleaf_deciduous_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_natural_${YEAR}_igp_0.008333Deg.tif = lc_shrub_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # c4 grass
    # r.mapcalc \
	# "lc_c4_grass_combined_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_natural_grass_igp_0.008333Deg * c4_nat_veg_frac_globe_0.008333Deg) + (esacci_lc_${YEAR}_managed_grass_igp_0.008333Deg * c4_crop_frac_globe_0.008333Deg)" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_c4_grass_natural_${YEAR}_igp_0.008333Deg.tif = lc_c4_grass_combined_${YEAR}_igp_0.008333Deg.tif - (esacci_lc_${YEAR}_cropland_igp_0.008333Deg.tif * c4_crop_frac_globe_0.008333Deg)" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_c4_grass_rainfed_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_rainfed_cropland_igp_0.008333Deg.tif * c4_crop_frac_globe_0.008333Deg)" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_c4_grass_irrigated_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_irrigated_cropland_igp_0.008333Deg.tif * c4_crop_frac_globe_0.008333Deg)" \
	# $OVERWRITE

    # # c3 grass
    # r.mapcalc \
	# "lc_c3_grass_combined_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_natural_grass_igp_0.008333Deg * (1-c4_nat_veg_frac_globe_0.008333Deg)) + (esacci_lc_${YEAR}_managed_grass_igp_0.008333Deg * (1-c4_crop_frac_globe_0.008333Deg))" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_c3_grass_natural_${YEAR}_igp_0.008333Deg.tif = lc_c3_grass_combined_${YEAR}_igp_0.008333Deg.tif - (esacci_lc_${YEAR}_cropland_igp_0.008333Deg.tif * (1-c4_crop_frac_globe_0.008333Deg))" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_c3_grass_rainfed_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_rainfed_cropland_igp_0.008333Deg.tif * (1-c4_crop_frac_globe_0.008333Deg))" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_c3_grass_irrigated_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_irrigated_cropland_igp_0.008333Deg.tif * (1-c4_crop_frac_globe_0.008333Deg))" \
	# $OVERWRITE

    # # urban
    # r.mapcalc \
	# "lc_urban_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_urban_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_urban_natural_${YEAR}_igp_0.008333Deg.tif = lc_urban_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_urban_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_urban_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # water
    # r.mapcalc \
	# "lc_water_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_water_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_water_natural_${YEAR}_igp_0.008333Deg.tif = lc_water_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_water_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_water_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # bare soil
    # r.mapcalc \
	# "lc_bare_soil_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_bare_soil_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_bare_soil_natural_${YEAR}_igp_0.008333Deg.tif = lc_bare_soil_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_bare_soil_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_bare_soil_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # snow/ice
    # r.mapcalc \
	# "lc_snow_ice_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_snow_ice_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_snow_ice_natural_${YEAR}_igp_0.008333Deg.tif = lc_snow_ice_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_snow_ice_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_snow_ice_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # # weighted elevation
    # # for LC in tree_broadleaf tree_needleleaf shrub c4_grass c3_grass urban water bare_soil snow_ice
    # # do
    # # 	r.mapcalc \
    # # 	    "lc_${LC}_${YEAR}_igp_0.008333Deg_weighted_elev = lc_${LC}_${YEAR}_igp_0.008333Deg * merit_dem_igp_0.008333Deg_surf_hgt" \
    # # 	    $OVERWRITE
    # # done

    # # ############
    # # (ii) 9 PFT
    # # ############

    # # tree broadleaf evergreen tropical
    # r.mapcalc \
	# "lc_tree_broadleaf_evergreen_tropical_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg * tropical_broadleaf_forest_globe_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_evergreen_tropical_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_broadleaf_evergreen_tropical_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_evergreen_tropical_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_evergreen_tropical_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # tree broadleaf evergreen temperate
    # r.mapcalc \
	# "lc_tree_broadleaf_evergreen_temperate_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg * (1-tropical_broadleaf_forest_globe_0.008333Deg)" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_evergreen_temperate_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_broadleaf_evergreen_temperate_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_evergreen_temperate_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_evergreen_temperate_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # tree broadleaf deciduous
    # r.mapcalc \
	# "lc_tree_broadleaf_deciduous_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_broadleaf_deciduous_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_deciduous_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_broadleaf_deciduous_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_deciduous_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_broadleaf_deciduous_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # tree needleleaf evergreen
    # r.mapcalc \
	# "lc_tree_needleleaf_evergreen_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_needleleaf_evergreen_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_evergreen_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_needleleaf_evergreen_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_evergreen_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_evergreen_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # tree needleleaf deciduous
    # r.mapcalc \
	# "lc_tree_needleleaf_deciduous_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_needleleaf_deciduous_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_deciduous_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_needleleaf_deciduous_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_deciduous_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_tree_needleleaf_deciduous_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # shrub evergreen
    # r.mapcalc \
	# "lc_shrub_evergreen_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_shrub_broadleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_needleleaf_evergreen_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_evergreen_natural_${YEAR}_igp_0.008333Deg.tif = lc_shrub_evergreen_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_evergreen_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_evergreen_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # shrub deciduous
    # r.mapcalc \
	# "lc_shrub_deciduous_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_shrub_broadleaf_deciduous_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_needleleaf_deciduous_igp_0.008333Deg" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_deciduous_natural_${YEAR}_igp_0.008333Deg.tif = lc_shrub_deciduous_combined_${YEAR}_igp_0.008333Deg.tif" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_deciduous_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE
    # r.mapcalc \
	# "lc_shrub_deciduous_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	# $OVERWRITE

    # # # weighted elevation
    # # for LC in tree_broadleaf_evergreen_tropical tree_broadleaf_evergreen_temperate tree_broadleaf_deciduous tree_needleleaf_evergreen tree_needleleaf_deciduous shrub_evergreen shrub_deciduous
    # # do
    # # 	r.mapcalc \
    # # 	    "lc_${LC}_${YEAR}_igp_0.008333Deg_weighted_elev = lc_${LC}_${YEAR}_igp_0.008333Deg * merit_dem_igp_0.008333Deg_surf_hgt" \
    # # 	    $OVERWRITE
    # # done

    # r.external.out -r

# Make JULES land cover fraction maps
# ===========================================================

chmod 755 $SRCDIR/bash/make_land_cover_fraction_lookup_tables.sh
bash $SRCDIR/bash/make_land_cover_fraction_lookup_tables.sh

# declare -a YEARS=({1992..2015})
declare -a YEARS=(2015)

g.region region=igp_0.002778Deg

# Setting mask will ensure values outside land mask are set to null
# esacci_land_frac_globe_0.002778Deg computed in grass_make_jules_land_frac.sh
# r.external -a input=${AUXDIR}/dem/merit_dem_globe_0.002778Deg.tif output=merit_dem_globe_0.002778Deg --overwrite
r.mask raster=esacci_land_frac_globe_0.002778Deg
# r.mapcalc \
#     "merit_dem_globe_0.002778Deg_surf_hgt = merit_dem_globe_0.002778Deg" \
#     --overwrite

# land sea mask @ 0.002778Deg
r.mapcalc \
    "land_sea_mask = esacci_land_frac_globe_0.002778Deg" \
    --overwrite
r.mask -r

# Loop through years and create land cover fractions/surface heights
for YEAR in "${YEARS[@]}"
do
    g.region region=igp_0.002778Deg

    r.in.gdal \
	-a \
	input=${ESACCIDIR}/ESACCI-LC-L4-LCCS-Map-300m-P1Y-${YEAR}-v2.0.7.tif \
	output=esacci_lc_${YEAR}_w_sea \
	$OVERWRITE

    # Mask sea values in esacci_lc_${YEAR}_w_sea by multiplying by
    # land_sea_mask, in which non-land cells are null.
    r.mapcalc \
    	"esacci_lc_${YEAR} = esacci_lc_${YEAR}_w_sea * land_sea_mask" \
    	$OVERWRITE

    # tree broadleaf evergreen
    # ########################
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_tree_broadleaf_evergreen_x1000 \
	rules=$AUXDIR/tree_broadleaf_evergreen_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_tree_broadleaf_evergreen_x1000 \
	output=esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg = esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # ########################
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_tree_broadleaf_deciduous_x1000 \
	rules=$AUXDIR/tree_broadleaf_deciduous_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_tree_broadleaf_deciduous_x1000 \
	output=esacci_lc_${YEAR}_tree_broadleaf_deciduous_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_tree_broadleaf_deciduous_igp_0.008333Deg = esacci_lc_${YEAR}_tree_broadleaf_deciduous_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # #########################
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_tree_needleleaf_evergreen_x1000 \
	rules=$AUXDIR/tree_needleleaf_evergreen_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_tree_needleleaf_evergreen_x1000 \
	output=esacci_lc_${YEAR}_tree_needleleaf_evergreen_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_tree_needleleaf_evergreen_igp_0.008333Deg = esacci_lc_${YEAR}_tree_needleleaf_evergreen_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # #########################
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_tree_needleleaf_deciduous_x1000 \
	rules=$AUXDIR/tree_needleleaf_deciduous_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_tree_needleleaf_deciduous_x1000 \
	output=esacci_lc_${YEAR}_tree_needleleaf_deciduous_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_tree_needleleaf_deciduous_igp_0.008333Deg = esacci_lc_${YEAR}_tree_needleleaf_deciduous_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # #########################
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_shrub_broadleaf_evergreen_x1000 \
	rules=$AUXDIR/shrub_broadleaf_evergreen_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_shrub_broadleaf_evergreen_x1000 \
	output=esacci_lc_${YEAR}_shrub_broadleaf_evergreen_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_shrub_broadleaf_evergreen_igp_0.008333Deg = esacci_lc_${YEAR}_shrub_broadleaf_evergreen_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # #########################
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_shrub_broadleaf_deciduous_x1000 \
	rules=$AUXDIR/shrub_broadleaf_deciduous_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_shrub_broadleaf_deciduous_x1000 \
	output=esacci_lc_${YEAR}_shrub_broadleaf_deciduous_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_shrub_broadleaf_deciduous_igp_0.008333Deg = esacci_lc_${YEAR}_shrub_broadleaf_deciduous_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # ##########################
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_shrub_needleleaf_evergreen_x1000 \
	rules=$AUXDIR/shrub_needleleaf_evergreen_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_shrub_needleleaf_evergreen_x1000 \
	output=esacci_lc_${YEAR}_shrub_needleleaf_evergreen_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_shrub_needleleaf_evergreen_igp_0.008333Deg = esacci_lc_${YEAR}_shrub_needleleaf_evergreen_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # shrub neefleleaf deciduous
    # ##########################
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_shrub_needleleaf_deciduous_x1000 \
	rules=$AUXDIR/shrub_needleleaf_deciduous_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_shrub_needleleaf_deciduous_x1000 \
	output=esacci_lc_${YEAR}_shrub_needleleaf_deciduous_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_shrub_needleleaf_deciduous_igp_0.008333Deg = esacci_lc_${YEAR}_shrub_needleleaf_deciduous_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # shrub neefleleaf deciduous
    # natural grass
    # #############
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_natural_grass_x1000 \
	rules=$AUXDIR/natural_grass_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_natural_grass_x1000 \
	output=esacci_lc_${YEAR}_natural_grass_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_natural_grass_igp_0.008333Deg = esacci_lc_${YEAR}_natural_grass_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # shrub neefleleaf deciduous
    # natural grass
    # managed grass
    # #############
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_managed_grass_x1000 \
	rules=$AUXDIR/managed_grass_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_managed_grass_x1000 \
	output=esacci_lc_${YEAR}_managed_grass_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_managed_grass_igp_0.008333Deg = esacci_lc_${YEAR}_managed_grass_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # shrub neefleleaf deciduous
    # natural grass
    # managed grass
    # urban
    # #####
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_urban_x1000 \
	rules=$AUXDIR/urban_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_urban_x1000 \
	output=esacci_lc_${YEAR}_urban_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_urban_igp_0.008333Deg = esacci_lc_${YEAR}_urban_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # shrub neefleleaf deciduous
    # natural grass
    # managed grass
    # urban
    # bare soil
    # #########
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_bare_soil_x1000 \
	rules=$AUXDIR/bare_soil_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_bare_soil_x1000 \
	output=esacci_lc_${YEAR}_bare_soil_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_bare_soil_igp_0.008333Deg = esacci_lc_${YEAR}_bare_soil_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # shrub neefleleaf deciduous
    # natural grass
    # managed grass
    # urban
    # bare soil
    # water
    # #####
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_water_x1000 \
	rules=$AUXDIR/water_reclass.txt \
	$OVERWRITE
    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_water_x1000 \
	output=esacci_lc_${YEAR}_water_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE
    r.mapcalc \
	"esacci_lc_${YEAR}_water_igp_0.008333Deg = esacci_lc_${YEAR}_water_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # shrub neefleleaf deciduous
    # natural grass
    # managed grass
    # urban
    # bare soil
    # water
    # snow/ice
    # ########
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_snow_ice_x1000 \
	rules=$AUXDIR/snow_ice_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_snow_ice_x1000 \
	output=esacci_lc_${YEAR}_snow_ice_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_snow_ice_igp_0.008333Deg = esacci_lc_${YEAR}_snow_ice_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # tree broadleaf evergreen
    # tree broadleaf deciduous
    # tree needleleaf evergreen
    # tree needleleaf deciduous
    # shrub broadleaf evergreen
    # shrub broadleaf deciduous
    # shrub needleleaf evergreen
    # shrub neefleleaf deciduous
    # natural grass
    # managed grass
    # urban
    # bare soil
    # water
    # snow/ice
    # no data
    # #######
    g.region region=igp_0.002778Deg
    r.reclass \
	input=esacci_lc_${YEAR} \
	output=esacci_lc_${YEAR}_nodata_x1000 \
	rules=$AUXDIR/nodata_reclass.txt \
	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_nodata_x1000 \
	output=esacci_lc_${YEAR}_nodata_igp_0.008333Deg_x1000 \
	method=average \
	$OVERWRITE

    r.mapcalc \
	"esacci_lc_${YEAR}_nodata_igp_0.008333Deg = esacci_lc_${YEAR}_nodata_igp_0.008333Deg_x1000 / 1000" \
	$OVERWRITE

    # Set up external output
    r.external.out \
	directory=${AUXDIR}/frac \
	format="GTiff" \
	options="COMPRESS=DEFLATE"

    # Additional classes:
    # ###################

    # These are the classes we use to compute agricultural land

    # Rainfed cropland (classes 10, 11)
    g.region region=igp_0.002778Deg
    r.mapcalc \
    	"esacci_lc_${YEAR}_rainfed_cropland.tif = if((esacci_lc_${YEAR} == 10) || (esacci_lc_${YEAR} == 11), 1, 0)" \
    	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_rainfed_cropland.tif \
	output=esacci_lc_${YEAR}_rainfed_cropland_igp_0.008333Deg.tif \
	method=average \
	$OVERWRITE

    # Irrigated cropland (class 20)
    g.region region=igp_0.002778Deg
    r.mapcalc \
    	"esacci_lc_${YEAR}_irrigated_cropland.tif = if((esacci_lc_${YEAR} == 20), 1, 0)" \
    	$OVERWRITE

    g.region region=igp_0.008333Deg
    r.resamp.stats \
	input=esacci_lc_${YEAR}_irrigated_cropland.tif \
	output=esacci_lc_${YEAR}_irrigated_cropland_igp_0.008333Deg.tif \
	method=average \
	$OVERWRITE

    # Combined:
    r.mapcalc \
	"esacci_lc_${YEAR}_cropland_igp_0.008333Deg.tif = esacci_lc_${YEAR}_rainfed_cropland_igp_0.008333Deg.tif + esacci_lc_${YEAR}_irrigated_cropland_igp_0.008333Deg.tif" \
	$OVERWRITE

    # ===================================================== #
    # Convert to JULES land cover types
    # ===================================================== #
    g.region region=igp_0.008333Deg

    # ###########
    # (i) 5 PFT
    # ###########

    # tree broadleaf
    r.mapcalc \
	"lc_tree_broadleaf_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_tree_broadleaf_deciduous_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_broadleaf_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # tree needleleaf
    r.mapcalc \
	"lc_tree_needleleaf_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_needleleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_tree_needleleaf_deciduous_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_needleleaf_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # shrub
    r.mapcalc \
	"lc_shrub_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_shrub_broadleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_broadleaf_deciduous_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_needleleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_needleleaf_deciduous_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_natural_${YEAR}_igp_0.008333Deg.tif = lc_shrub_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # c4 grass
    r.mapcalc \
	"lc_c4_grass_combined_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_natural_grass_igp_0.008333Deg * c4_nat_veg_frac_globe_0.008333Deg) + (esacci_lc_${YEAR}_managed_grass_igp_0.008333Deg * c4_crop_frac_globe_0.008333Deg)" \
	$OVERWRITE
    r.mapcalc \
	"lc_c4_grass_natural_${YEAR}_igp_0.008333Deg.tif = lc_c4_grass_combined_${YEAR}_igp_0.008333Deg.tif - (esacci_lc_${YEAR}_cropland_igp_0.008333Deg.tif * c4_crop_frac_globe_0.008333Deg)" \
	$OVERWRITE
    r.mapcalc \
	"lc_c4_grass_rainfed_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_rainfed_cropland_igp_0.008333Deg.tif * c4_crop_frac_globe_0.008333Deg)" \
	$OVERWRITE
    r.mapcalc \
	"lc_c4_grass_irrigated_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_irrigated_cropland_igp_0.008333Deg.tif * c4_crop_frac_globe_0.008333Deg)" \
	$OVERWRITE

    # c3 grass
    r.mapcalc \
	"lc_c3_grass_combined_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_natural_grass_igp_0.008333Deg * (1-c4_nat_veg_frac_globe_0.008333Deg)) + (esacci_lc_${YEAR}_managed_grass_igp_0.008333Deg * (1-c4_crop_frac_globe_0.008333Deg))" \
	$OVERWRITE
    r.mapcalc \
	"lc_c3_grass_natural_${YEAR}_igp_0.008333Deg.tif = lc_c3_grass_combined_${YEAR}_igp_0.008333Deg.tif - (esacci_lc_${YEAR}_cropland_igp_0.008333Deg.tif * (1-c4_crop_frac_globe_0.008333Deg))" \
	$OVERWRITE
    r.mapcalc \
	"lc_c3_grass_rainfed_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_rainfed_cropland_igp_0.008333Deg.tif * (1-c4_crop_frac_globe_0.008333Deg))" \
	$OVERWRITE
    r.mapcalc \
	"lc_c3_grass_irrigated_${YEAR}_igp_0.008333Deg.tif = (esacci_lc_${YEAR}_irrigated_cropland_igp_0.008333Deg.tif * (1-c4_crop_frac_globe_0.008333Deg))" \
	$OVERWRITE

    # urban
    r.mapcalc \
	"lc_urban_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_urban_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_urban_natural_${YEAR}_igp_0.008333Deg.tif = lc_urban_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_urban_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_urban_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # water
    r.mapcalc \
	"lc_water_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_water_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_water_natural_${YEAR}_igp_0.008333Deg.tif = lc_water_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_water_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_water_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # bare soil
    r.mapcalc \
	"lc_bare_soil_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_bare_soil_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_bare_soil_natural_${YEAR}_igp_0.008333Deg.tif = lc_bare_soil_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_bare_soil_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_bare_soil_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # snow/ice
    r.mapcalc \
	"lc_snow_ice_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_snow_ice_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_snow_ice_natural_${YEAR}_igp_0.008333Deg.tif = lc_snow_ice_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_snow_ice_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_snow_ice_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # # weighted elevation
    # for LC in tree_broadleaf tree_needleleaf shrub c4_grass c3_grass urban water bare_soil snow_ice
    # do
    # 	r.mapcalc \
    # 	    "lc_${LC}_${YEAR}_igp_0.008333Deg_weighted_elev = lc_${LC}_${YEAR}_igp_0.008333Deg * merit_dem_igp_0.008333Deg_surf_hgt" \
    # 	    $OVERWRITE
    # done

    # ############
    # (ii) 9 PFT
    # ############

    # tree broadleaf evergreen tropical
    r.mapcalc \
	"lc_tree_broadleaf_evergreen_tropical_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg * tropical_broadleaf_forest_globe_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_evergreen_tropical_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_broadleaf_evergreen_tropical_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_evergreen_tropical_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_evergreen_tropical_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # tree broadleaf evergreen temperate
    r.mapcalc \
	"lc_tree_broadleaf_evergreen_temperate_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_broadleaf_evergreen_igp_0.008333Deg * (1-tropical_broadleaf_forest_globe_0.008333Deg)" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_evergreen_temperate_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_broadleaf_evergreen_temperate_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_evergreen_temperate_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_evergreen_temperate_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # tree broadleaf deciduous
    r.mapcalc \
	"lc_tree_broadleaf_deciduous_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_broadleaf_deciduous_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_deciduous_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_broadleaf_deciduous_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_deciduous_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_broadleaf_deciduous_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # tree needleleaf evergreen
    r.mapcalc \
	"lc_tree_needleleaf_evergreen_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_needleleaf_evergreen_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_evergreen_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_needleleaf_evergreen_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_evergreen_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_evergreen_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # tree needleleaf deciduous
    r.mapcalc \
	"lc_tree_needleleaf_deciduous_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_tree_needleleaf_deciduous_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_deciduous_natural_${YEAR}_igp_0.008333Deg.tif = lc_tree_needleleaf_deciduous_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_deciduous_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_tree_needleleaf_deciduous_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # shrub evergreen
    r.mapcalc \
	"lc_shrub_evergreen_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_shrub_broadleaf_evergreen_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_needleleaf_evergreen_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_evergreen_natural_${YEAR}_igp_0.008333Deg.tif = lc_shrub_evergreen_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_evergreen_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_evergreen_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # shrub deciduous
    r.mapcalc \
	"lc_shrub_deciduous_combined_${YEAR}_igp_0.008333Deg.tif = esacci_lc_${YEAR}_shrub_broadleaf_deciduous_igp_0.008333Deg + esacci_lc_${YEAR}_shrub_needleleaf_deciduous_igp_0.008333Deg" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_deciduous_natural_${YEAR}_igp_0.008333Deg.tif = lc_shrub_deciduous_combined_${YEAR}_igp_0.008333Deg.tif" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_deciduous_rainfed_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE
    r.mapcalc \
	"lc_shrub_deciduous_irrigated_${YEAR}_igp_0.008333Deg.tif = 0" \
	$OVERWRITE

    # # weighted elevation
    # for LC in tree_broadleaf_evergreen_tropical tree_broadleaf_evergreen_temperate tree_broadleaf_deciduous tree_needleleaf_evergreen tree_needleleaf_deciduous shrub_evergreen shrub_deciduous
    # do
    # 	r.mapcalc \
    # 	    "lc_${LC}_${YEAR}_igp_0.008333Deg_weighted_elev = lc_${LC}_${YEAR}_igp_0.008333Deg * merit_dem_igp_0.008333Deg_surf_hgt" \
    # 	    $OVERWRITE
    # done

    r.external.out -r

done
